name: Deploy API Documentation
on:
  push:
    branches:
      - api-documentation-github-pages
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy-docs:
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Get Latest Swagger UI Release
        id: swagger-ui
        env:
          CURRENT_SWAGGER_VERSION: v5.11.0
        run: |
          release_tag=$(curl -sL https://api.github.com/repos/swagger-api/swagger-ui/releases/latest | jq -r ".tag_name")
          echo "release_tag=$release_tag" >> $GITHUB_OUTPUT
          current_tag=$CURRENT_SWAGGER_VERSION
          echo "current_tag=$current_tag" >> $GITHUB_OUTPUT

      - name: Copy openapi json spec to root
        run: cp docs/openapi.json openapi.json

      - name: Update Swagger UI
        # if: steps.swagger-ui.outputs.current_tag != steps.swagger-ui.outputs.release_tag
        env:
          RELEASE_TAG: ${{ steps.swagger-ui.outputs.release_tag }}
          OPENAPI_FILE: "openapi.json"
        run: |
          # Creates the docs-dist folder
          mkdir -p docs-dist
          mkdir -p swagger-ui
          # Download the release
          curl -sL -o $RELEASE_TAG https://api.github.com/repos/swagger-api/swagger-ui/tarball/$RELEASE_TAG
          # Extract the dist directory
          tar -xzf $RELEASE_TAG --strip-components=1 -C ./swagger-ui $(tar -tzf $RELEASE_TAG | head -1 | cut -f1 -d"/")/dist
          rm $RELEASE_TAG
          # Move index.html to the docs-dist folder
          mv swagger-ui/dist/index.html ./docs-dist/
          # Fix references in swagger-ui/dist/swagger-initializer and index.html
          sed -i "s|https://petstore.swagger.io/v2/swagger.json|$OPENAPI_FILE|g" swagger-ui/dist/swagger-initializer.js
          sed -i "s|href=\"./|href=\"dist/|g" ./docs-dist/index.html
          sed -i "s|src=\"./|src=\"dist/|g" ./docs-dist/index.html
          sed -i "s|href=\"index|href=\"dist/index|g" ./docs-dist/index.html
          # Update current release
          # echo ${{ steps.swagger-ui.outputs.release_tag }} > swagger-ui.version

      # - name: Deploy
      #   uses: peaceiris/actions-gh-pages@v3
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     publish_dir: ./docs-dist
      #     destination_dir: ./docs-dist
      #     publish_branch: api-documentation-github-pages

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs-dist
    
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - run: echo "GH_REPO=$(echo ${{ github.repository }} | cut -d "/" -f 2)" >> $GITHUB_ENV

      - run: echo "[Deploying to ${{ steps.deployment.outputs.page_url }}](${{ steps.deployment.outputs.page_url }}" >> "${GITHUB_STEP_SUMMARY}"
